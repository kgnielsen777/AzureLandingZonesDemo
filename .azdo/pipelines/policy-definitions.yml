---
trigger:
  paths:
    include:
      - .azdo/pipelines/policy-definitions.yml
      - modules/policies/policy-definitions/**
    exclude:
      - README.md

variables:
  vmImage: ubuntu-latest

stages:
  - stage: build
    displayName: Build & Test
    jobs:
      - job: build
        displayName: Build & Test
        variables:
          - template: ../../environments/canary/vars.yml
        pool:
          vmImage: $(vmImage)
        steps:
          - task: PowerShell@2
            displayName: Run Pester Tests
            inputs:
              targetType: inline
              script: |
                Invoke-Pester -Path modules/policies/scripts/Test-Policy.Tests.ps1 -CI
              pwsh: true

          - task: PublishTestResults@2
            displayName: Publish Test Results
            inputs:
              testResultsFormat: NUnit
              testResultsFiles: "**/testResults.xml"
              failTaskOnFailedTests: true
              failTaskOnMissingResultsFile: true

          - task: AzureCLI@2
            displayName: Build Template
            inputs:
              azureSubscription: ${{ variables.azureConnection }}
              scriptType: pscore
              scriptLocation: inlineScript
              inlineScript: |
                ./modules/policies/scripts/Build-PolicyDefinitionTemplate.ps1 -OutFile main.bicep
                az bicep build --file modules/policies/policy-definitions/main.bicep --outfile $(Build.ArtifactStagingDirectory)/main.json
                az bicep build-params --file modules/policies/scripts/empty.bicepparam --outfile $(Build.ArtifactStagingDirectory)/main.canary.parameters.json
                az bicep build-params --file modules/policies/scripts/empty.bicepparam --outfile $(Build.ArtifactStagingDirectory)/main.prod.parameters.json
              failOnStandardError: true

          - task: PublishPipelineArtifact@1
            displayName: Publish Artifacts
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: drop
              publishLocation: pipeline

  - stage: validate
    displayName: Validate
    dependsOn: build
    jobs:
      - deployment: canary
        displayName: Canary
        condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/main'))
        variables:
          - template: ../../environments/canary/vars.yml
        pool:
          vmImage: $(vmImage)
        environment: Canary
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzurePowerShell@5
                  displayName: Compare policy definitions
                  inputs:
                    azureSubscription: ${{ variables.azureConnection }}
                    ScriptType: InlineScript
                    Inline: |
                      $(Build.SourcesDirectory)/modules/policies/scripts/Compare-PolicyDefinition.ps1 -Path $(Build.SourcesDirectory)/modules/policies/policy-definitions -ManagementGroupId ${{ variables.managementGroupId }}
                    azurePowerShellVersion: LatestVersion
                    pwsh: true

                - template: templates/management-group-deployment.yml
                  parameters:
                    deploymentName: policy-definitions
                    environment: canary
                    command: validate
                    azureConnection: ${{ variables.azureConnection }}
                    location: ${{ variables.location }}
                    managementGroupId: ${{ variables.managementGroupId }}
                    templateFile: $(Pipeline.Workspace)/drop/main.json
                    parameters: $(Pipeline.Workspace)/drop/main.canary.parameters.json

                - template: templates/management-group-deployment.yml
                  parameters:
                    deploymentName: policy-definitions
                    environment: canary
                    command: what-if
                    azureConnection: ${{ variables.azureConnection }}
                    location: ${{ variables.location }}
                    managementGroupId: ${{ variables.managementGroupId }}
                    templateFile: $(Pipeline.Workspace)/drop/main.json
                    parameters: $(Pipeline.Workspace)/drop/main.canary.parameters.json

      - deployment: prod
        displayName: Production
        variables:
          - template: ../../environments/prod/vars.yml
        pool:
          vmImage: $(vmImage)
        environment: Production
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates/management-group-deployment.yml
                  parameters:
                    deploymentName: policy-definitions
                    environment: prod
                    command: validate
                    azureConnection: ${{ variables.azureConnection }}
                    location: ${{ variables.location }}
                    managementGroupId: ${{ variables.managementGroupId }}
                    templateFile: $(Pipeline.Workspace)/drop/main.json
                    parameters: $(Pipeline.Workspace)/drop/main.prod.parameters.json

                - template: templates/management-group-deployment.yml
                  parameters:
                    deploymentName: policy-definitions
                    environment: prod
                    command: what-if
                    azureConnection: ${{ variables.azureConnection }}
                    location: ${{ variables.location }}
                    managementGroupId: ${{ variables.managementGroupId }}
                    templateFile: $(Pipeline.Workspace)/drop/main.json
                    parameters: $(Pipeline.Workspace)/drop/main.prod.parameters.json


  - stage: deploy
    displayName: Deploy
    dependsOn: validate
    jobs:
      - deployment: canary
        displayName: Canary
        condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/main'))
        variables:
          - template: ../../environments/canary/vars.yml
        pool:
          vmImage: $(vmImage)
        environment: Canary
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates/management-group-deployment.yml
                  parameters:
                    deploymentName: policy-definitions
                    environment: canary
                    command: create
                    azureConnection: ${{ variables.azureConnection }}
                    location: ${{ variables.location }}
                    managementGroupId: ${{ variables.managementGroupId }}
                    templateFile: $(Pipeline.Workspace)/drop/main.json
                    parameters: $(Pipeline.Workspace)/drop/main.canary.parameters.json

      - deployment: prod
        displayName: Production
        condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
        variables:
          - template: ../../environments/prod/vars.yml
        pool:
          vmImage: $(vmImage)
        environment: Production
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates/management-group-deployment.yml
                  parameters:
                    deploymentName: policy-definitions
                    environment: prod
                    command: create
                    azureConnection: ${{ variables.azureConnection }}
                    location: ${{ variables.location }}
                    managementGroupId: ${{ variables.managementGroupId }}
                    templateFile: $(Pipeline.Workspace)/drop/main.json
                    parameters: $(Pipeline.Workspace)/drop/main.prod.parameters.json
